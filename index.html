<!doctype html>
<html lang="en">
<head>
<script>
    window.addEventListener("load", function(){
        var button = opera.contexts.toolbar.createItem({
            disabled : false
            ,title: "The Old Reader"
            ,icon: "icon-inactive.png"
            ,badge: {
                display: "none",
                textContent: "",
                color: "white",
                backgroundColor: "rgba(211, 0, 4, 1)"
            }
        });

        opera.contexts.toolbar.addItem(button);

        button.addEventListener('click',function(){
            var oTabs = opera.extension.tabs;
         	if(!oTabs) return;
   			oTabs.create({url: 'http://theoldreader.com', focused: true});
        }, false);


        var Failure = function (error) {
            button.badge.display = "block";
            button.badge.textContent = " ? ";
            button.icon = "icon-inactive.png";
            button.title = 'The Old Reader\n\n'+error;
            setTimeout( function(){ Update(); } , 30000 );
        };

        var Success = function (feedData) {
            var s = 'The Old Reader\n';
            var count = 0;
            var i, folder;
            for (i=0; folder=feedData.feeds[i]; i++) {
                var k, feed;
                for (k=0; feed=folder.feeds[k]; k++) {
                    if (feed.unread_count) {
                        s += '\n' + feed.title + ': ' + feed.unread_count;
                        count += feed.unread_count;
                    }
                }
            }
            for (i=0; folder=feedData.following[i]; i++) {
                if (folder.unread_count) {
                    count += folder.unread_count;
                }
            }
            button.badge.textContent = count;
            button.badge.display = count == 0 ? "none" : "block";
            button.icon = "icon-active.png";
            button.title = s;
            setTimeout( function(){ Update(); } , 60000 );
        };

        var Update = function() {
            var httpRequest = new XMLHttpRequest();
            var requestTimeout = window.setTimeout(function() { httpRequest.abort(); Failure('Error communicating with the server. Request timed out.'); }, 20000);
            httpRequest.onerror = function() { Failure('Error communicating with the server.'); };
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    window.clearTimeout(requestTimeout);
                    if (httpRequest.status == 401) {
                        Failure('You are not logged in.');
                    }
                    else if (httpRequest.status >= 400) {
                        Failure('Error communicating with the server. HTTP status '+httpRequest.status+'.');
                    }
                    else if (httpRequest.responseText) {
                        var feedData = {};
                        try {
                            eval('feedData='+httpRequest.responseText);
                            Success(feedData);
                        }
                        catch (exception) {
                            Failure('Error communicating with the server. Invalid server response.');
                        }
                    }
                    else {
                        Failure('Error communicating with the server. Invalid server response.');
                    }
                }
            };
            try {
                httpRequest.open('GET', 'http://theoldreader.com/feeds/counts.json', true);
                httpRequest.send(null);
            } catch (exception) {
                Failure('Error communicating with the server.');
            }
        };
        Update();


    }, false);
</script>
</head>
<body>
</body>
</html>